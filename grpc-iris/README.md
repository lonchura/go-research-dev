# 【详细】Go语言 gRPC iris 微服务调用
> 原文参考：https://www.tuicool.com/articles/7FzQvi7

## 环境设置
> 
* 参考
    * [Web快速MVC开发框架 iris](mweblib://15918453851989)
    * https://www.jianshu.com/p/f623bbc283e3

## 安装protoc
### Mac
```bash
# 安装protoc及plugin-go
brew install protoc-gen-go
```

## 项目初始化
```bash
# workspace
mkdir -p $GOPATH/lonchura.demo/grpc-iris
cd $GOPATH/lonchura.demo/grpc-iris

# go mod init
go mod init lonchura.demo/grpc-iris

# 下载grpc包
go get -u google.golang.org/grpc
# 下载iris框架包
go get -u github.com/kataras/iris
```

## 项目结构
```bash
grpc-iris
│  go.mod
│  go.sum
│  README.md
│
├─proto
│      README.md
│      servers.pb.go
│      servers.proto
│
└─servers
        main.go
        services.go
```

## proto定义与生成
> 定义servers.proto

```c
// 声明了 proto 语法版本
syntax = "proto3";

// 包名
package proto;

// 接口中使用的变量声明
message Id {
    int32 id=1;
}
message Name {
    string name=1;
}
message Age {
    int32 age=1;
}
// 用户变量
message User {
    int32 id=1;
    string name=2;
    int32 age=3;
}
// 用户参数
message UserParams{
    Name name=1;
    Age age=2;
}

// 声明哪些方法可以使用rpc
service ServiceSearch{
    rpc SaveUser(UserParams) returns (Id){}
    rpc UserInfo(Id) returns (User){}
}
```

> 编译生成servers.pb.go

```bash
protoc -I proto servers.proto --go_out=plugins=grpc:proto
#或 
# cd proto
# protoc --go_out=plugins=grpc:. *.proto
```

> **servers.pb.go**
> 可以看到最后有一个 RegisterServiceSearchServer 注册服务的方法
> 接受一个 grpc.Server 与一个 ServiceSearchServer 的接口
> 而我们在 servers/services.go 中，主要就是实现 ServiceSearchServer 这个接口
> 并通过 RegisterServiceSearchServer 将接口实现的函数注册 rpc 服务中

```go
// 声明了 proto 语法版本

// Code generated by protoc-gen-go. DO NOT EDIT.
// versions:
// 	protoc-gen-go v1.23.0
// 	protoc        v3.12.3
// source: servers.proto

// 包名
package proto

......

// ServiceSearchServer is the server API for ServiceSearch service.
type ServiceSearchServer interface {
	SaveUser(context.Context, *UserParams) (*Id, error)
	UserInfo(context.Context, *Id) (*User, error)
}

// UnimplementedServiceSearchServer can be embedded to have forward compatible implementations.
type UnimplementedServiceSearchServer struct {
}

func (*UnimplementedServiceSearchServer) SaveUser(context.Context, *UserParams) (*Id, error) {
	return nil, status.Errorf(codes.Unimplemented, "method SaveUser not implemented")
}
func (*UnimplementedServiceSearchServer) UserInfo(context.Context, *Id) (*User, error) {
	return nil, status.Errorf(codes.Unimplemented, "method UserInfo not implemented")
}

func RegisterServiceSearchServer(s *grpc.Server, srv ServiceSearchServer) {
	s.RegisterService(&_ServiceSearch_serviceDesc, srv)
}

......
```

## RPC接口的实现
> servers/services.go

```go
package main

import (
	"context"
	"fmt"
	"google.golang.org/grpc"
	"lonchura.demo/grpc-iris/proto"
	"log"
	"math/rand"
	"net"
)

type ServiceSearch struct{}

func main() {
	listen, err := net.Listen("tcp", "127.0.0.1:9527")
	if err != nil {
		log.Fatalf("tcp listen failed:%v", err)
	}
	server := grpc.NewServer()
	fmt.Println("services start success")
	proto.RegisterServiceSearchServer(server, &ServiceSearch{})
	server.Serve(listen)

}

//保存用户
func (Service *ServiceSearch) SaveUser(ctx context.Context, params *proto.UserParams) (*proto.Id, error) {
	id := rand.Int31n(10) //随机生成id 模式保存成功
	res := &proto.Id{Id: id}
	fmt.Printf("username:%s,age:%d\r\n", params.Name, params.Age)
	return res, nil
}

func (Service *ServiceSearch) UserInfo(ctx context.Context, id *proto.Id) (*proto.User, error) {
	res := &proto.User{Id:id.GetId(),Name:"test",Age:31}
	return res, nil
}
```

## RPC接口的调用
> **servers/main.go**
> * 这里使用了iris对外提供服务
> * 这里创建了一个rpc的client
>   * 在使用的时候我们只需要调用 services 里面已经写好的函数即可

```go
package main

import (
	"context"
	"github.com/kataras/iris"
	"google.golang.org/grpc"
	"lonchura.demo/grpc-iris/proto"
	"log"
)

var client proto.ServiceSearchClient

func main() {
	app := iris.New()
	app.Logger().SetLevel("debug") //debug
	app.Handle("GET", "/testSaveUser", saveUser)
	app.Handle("GET", "/testUserInfo", userInfo)
	app.Run(iris.Addr("127.0.0.1:8080"))
}

func saveUser(ctx iris.Context) {
	params := proto.UserParams{}
	params.Age = &proto.Age{Age: 31}
	params.Name = &proto.Name{Name: "test"}
	res, err := client.SaveUser(context.Background(), &params)
	if err != nil {
		log.Fatalf("client.SaveUser err: %v", err)
	}
	ctx.JSON(res)
}

func userInfo(ctx iris.Context) {
	res, err := client.UserInfo(context.Background(), &proto.Id{Id: 1})
	if err != nil {
		log.Fatalf("client.userInfo err: %v", err)
	}
	ctx.JSON(res)
}

func init() {
	connect, err := grpc.Dial("127.0.0.1:9527", grpc.WithInsecure())
	if err != nil {
		log.Fatalln(err)
	}
	client = proto.NewServiceSearchClient(connect)
}
```

## 测试效果
> 启动RPC服务

```bash
$ go run servers/services.go 
services start success
```

> 启动Iris服务

```bash
$ go run servers/main.go 
[DBUG] 2020/06/19 17:14 GET: /testSaveUser -> main.saveUser()
[DBUG] 2020/06/19 17:14 GET: /testUserInfo -> main.userInfo()
[DBUG] 2020/06/19 17:14 Application: running using 1 host(s)
[DBUG] 2020/06/19 17:14 Host: addr is 127.0.0.1:8080
[DBUG] 2020/06/19 17:14 Host: virtual host is 127.0.0.1:8080
[DBUG] 2020/06/19 17:14 Host: register startup notifier
[DBUG] 2020/06/19 17:14 Host: register server shutdown on interrupt(CTRL+C/CMD+C)
Now listening on: http://127.0.0.1:8080
Application started. Press CMD+C to shut down.
```

> 访问
> * http://127.0.0.1:8080/testSaveUser
> * http://127.0.0.1:8080/testUserInfo